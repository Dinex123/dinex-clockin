// server.js
const express    = require('express');
const path       = require('path');
const fs         = require('fs');
const bodyParser = require('body-parser');
const moment     = require('moment-timezone');
const sqlite3    = require('sqlite3').verbose();

const app  = express();
const PORT = 3000;
const db   = new sqlite3.Database('./db/dev.db');

app.use(bodyParser.json());

// 2.1) Agregar marcaje
app.post('/api/agregar-marcaje', (req, res) => {
  const { usuario, departamento, tipo, fecha, hora } = req.body;
  const ip = req.ip;
  const sql = `INSERT INTO registros (usuario, tipo, fecha, hora, ip, departamento) VALUES (?, ?, ?, ?, ?, ?)`;
  db.run(sql, [usuario, tipo, fecha, hora, ip, departamento], err => {
    if (err) return res.json({ success: false, mensaje: "Error al guardar el registro." });
    const p = path.join(__dirname, 'marcajes.json');
    let all = [];
    try {
      const raw = fs.readFileSync(p, 'utf8').trim();
      all = raw ? JSON.parse(raw) : [];
    } catch (_) { all = []; }
    all.push({ usuario, departamento, tipo, fecha, hora, ip });
    fs.writeFileSync(p, JSON.stringify(all, null, 2), 'utf8');
    res.json({ success: true, mensaje: "Registro guardado correctamente." });
  });
});

// 2.2) Login administrador
app.post('/api/admin-login', (req, res) => {
  const { username, password } = req.body;
  const admins = JSON.parse(fs.readFileSync('admins.json', 'utf8'));
  const valid  = admins.some(a => a.username === username && a.password === password);
  res.json({ success: valid });
});

// 2.3) Crear usuario
app.post('/api/crear-usuario', (req, res) => {
  const uPath = path.join(__dirname, 'users.json');
  if (!fs.existsSync(uPath)) fs.writeFileSync(uPath, '[]', 'utf8');
  const users = JSON.parse(fs.readFileSync(uPath, 'utf8'));
  if (users.some(u => u.usuario === req.body.usuario)) {
    return res.json({ success: false, mensaje: "Usuario ya existe." });
  }
  users.push(req.body);
  fs.writeFileSync(uPath, JSON.stringify(users, null, 2), 'utf8');
  res.json({ success: true, mensaje: "Usuario creado correctamente." });
});

// 2.4) Login usuario
app.post('/api/login-usuario', (req, res) => {
  const uPath = path.join(__dirname, 'users.json');
  if (!fs.existsSync(uPath)) return res.json({ success: false });
  const users = JSON.parse(fs.readFileSync(uPath, 'utf8'));
  const u = users.find(u =>
    u.usuario === req.body.usuario &&
    u.contrasena === req.body.contrasena &&
    u.activo !== false
  );
  res.json(u ? { success: true, departamento: u.departamento } : { success: false });
});

// 2.5) Marcaje diario
app.post('/api/marcar', (req, res) => {
  const p = path.join(__dirname, 'marcajes.json');
  let all = [];
  try {
    const raw = fs.readFileSync(p, 'utf8').trim();
    all = raw ? JSON.parse(raw) : [];
  } catch (_) { all = []; }
  const now = moment().tz('America/Chicago');
  const fecha = now.format('YYYY-MM-DD');
  const hora  = now.format('HH:mm:ss');
  const count = all.filter(x => x.usuario === req.body.usuario && x.fecha === fecha).length;
  if (count >= 4) return res.json({ success: false, mensaje: 'Su turno ya terminó.' });
  all.push({ ...req.body, fecha, hora, ip: req.ip });
  fs.writeFileSync(p, JSON.stringify(all, null, 2), 'utf8');
  res.json({ success: true, mensaje: `Marcaje de ${req.body.tipo} registrado a las ${hora}` });
});

// 2.6) Reporte por usuario
app.get('/api/reporte', (req, res) => {
  const p = path.join(__dirname, 'marcajes.json');
  if (!fs.existsSync(p)) return res.json([]);
  const raw = fs.readFileSync(p, 'utf8').trim();
  const all = raw ? JSON.parse(raw) : [];
  const filt = all.filter(x => x.usuario === req.query.usuario);
  res.json(filt);
});

// 2.7) Listar empleados
app.get('/api/empleados', (req, res) => {
  const uPath = path.join(__dirname, 'users.json');
  if (!fs.existsSync(uPath)) return res.json([]);
  const users = JSON.parse(fs.readFileSync(uPath, 'utf8'));
  res.json(users.filter(u => u.activo !== false));
});

// 2.7.1) Obtener nombres completos
app.get('/api/usuarios', (req, res) => {
  const uPath = path.join(__dirname, 'users.json');
  if (!fs.existsSync(uPath)) return res.status(404).json({ error: 'Archivo users.json no encontrado' });
  const users = JSON.parse(fs.readFileSync(uPath, 'utf8'));
  const nombres = {};
  users.forEach(u => { nombres[u.usuario] = u.nombre; });
  res.json(nombres);
});

// 2.8) Reporte global
app.get('/api/reporte-todos', (req, res) => {
  try {
    const p = path.join(__dirname, 'marcajes.json');
    if (!fs.existsSync(p)) return res.json([]);
    const raw = fs.readFileSync(p, 'utf8').trim();
    const todos = raw ? JSON.parse(raw) : [];
    todos.sort((a, b) => {
      if (a.usuario !== b.usuario) return a.usuario.localeCompare(b.usuario);
      if (a.fecha !== b.fecha) return a.fecha.localeCompare(b.fecha);
      return (a.hora||'').localeCompare(b.hora||'');
    });
    res.json(todos);
  } catch (err) {
    console.error('Error en GET /api/reporte-todos:', err);
    res.status(500).json({ error: 'Error interno leyendo marcajes.' });
  }
});

// 2.15) Reset de contraseña por administrador
app.post('/api/reset-password-admin', (req, res) => {
  const { usuario, nuevaClave } = req.body;
  const uPath = path.join(__dirname, 'users.json');
  if (!fs.existsSync(uPath)) return res.json({ success: false, message: 'Archivo no encontrado' });
  let users = JSON.parse(fs.readFileSync(uPath, 'utf8'));
  const idx = users.findIndex(u => u.usuario === usuario);
  if (idx === -1) return res.json({ success: false, message: 'Empleado no encontrado' });
  users[idx].contrasena = nuevaClave;
  fs.writeFileSync(uPath, JSON.stringify(users, null, 2), 'utf8');
  res.json({ success: true });
});

// Estáticos y servidor
app.use(express.static(path.join(__dirname, 'public')));
app.listen(PORT, () => {
  console.log(`Servidor corriendo en http://localhost:${PORT}`);
});